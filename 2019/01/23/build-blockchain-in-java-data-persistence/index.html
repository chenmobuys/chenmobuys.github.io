<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>基于Java语言构建区块链（三）—— 持久化 &amp; 命令行 - Chenmobuys</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Chenmobuys"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Chenmobuys"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="文章的主要思想和内容均来自：https:&amp;#x2F;&amp;#x2F;jeiwan.cc&amp;#x2F;posts&amp;#x2F;building-blockchain-in-go-part-3&amp;#x2F;  引言上一篇 文章我们实现了区块链的工作量证明机制（Pow），尽可能地实现了挖矿。但是距离真正的区块链应用还有很多重要的特性没有实现。今天我们来实现区块链数据的存储机制，将每次生成的区块链数据保存下来。有一点需要注意，区块链本质上是一款分布式的数据库，"><meta property="og:type" content="blog"><meta property="og:title" content="基于Java语言构建区块链（三）—— 持久化 &amp; 命令行"><meta property="og:url" content="https://chenmobuys.github.io/2019/01/23/build-blockchain-in-java-data-persistence/"><meta property="og:site_name" content="Chenmobuys"><meta property="og:description" content="文章的主要思想和内容均来自：https:&amp;#x2F;&amp;#x2F;jeiwan.cc&amp;#x2F;posts&amp;#x2F;building-blockchain-in-go-part-3&amp;#x2F;  引言上一篇 文章我们实现了区块链的工作量证明机制（Pow），尽可能地实现了挖矿。但是距离真正的区块链应用还有很多重要的特性没有实现。今天我们来实现区块链数据的存储机制，将每次生成的区块链数据保存下来。有一点需要注意，区块链本质上是一款分布式的数据库，"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://chenmobuys.github.io/images/Millerblockchainadj-3200x2400.webp"><meta property="og:image" content="https://img.i7years.com/blog/blockchain_flow.jpg"><meta property="article:published_time" content="2019-01-23T02:34:07.000Z"><meta property="article:modified_time" content="2021-08-16T07:27:14.917Z"><meta property="article:author" content="Chenmobuys"><meta property="article:tag" content="blockchain"><meta property="article:tag" content="java"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/images/Millerblockchainadj-3200x2400.webp"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://chenmobuys.github.io/2019/01/23/build-blockchain-in-java-data-persistence/"},"headline":"基于Java语言构建区块链（三）—— 持久化 & 命令行","image":["https://chenmobuys.github.io/images/Millerblockchainadj-3200x2400.webp","https://img.i7years.com/blog/blockchain_flow.jpg"],"datePublished":"2019-01-23T02:34:07.000Z","dateModified":"2021-08-16T07:27:14.917Z","author":{"@type":"Person","name":"Chenmobuys"},"publisher":{"@type":"Organization","name":"Chenmobuys","logo":{"@type":"ImageObject","url":{"text":"Chenmobuys"}}},"description":"文章的主要思想和内容均来自：https:&#x2F;&#x2F;jeiwan.cc&#x2F;posts&#x2F;building-blockchain-in-go-part-3&#x2F;  引言上一篇 文章我们实现了区块链的工作量证明机制（Pow），尽可能地实现了挖矿。但是距离真正的区块链应用还有很多重要的特性没有实现。今天我们来实现区块链数据的存储机制，将每次生成的区块链数据保存下来。有一点需要注意，区块链本质上是一款分布式的数据库，"}</script><link rel="canonical" href="https://chenmobuys.github.io/2019/01/23/build-blockchain-in-java-data-persistence/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://unpkg.com/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://unpkg.com/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://unpkg.com/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://unpkg.com/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://unpkg.com/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Chenmobuys" type="application/atom+xml">
</head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Chenmobuys</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-01-23T02:34:07.000Z" title="2019/1/23 上午10:34:07">2019-01-23</time>发表</span><span class="level-item"><time dateTime="2021-08-16T07:27:14.917Z" title="2021/8/16 下午3:27:14">2021-08-16</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/java/">java</a></span><span class="level-item">19 分钟读完 (大约2885个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">基于Java语言构建区块链（三）—— 持久化 &amp; 命令行</h1><div class="content"><p><img src="/images/Millerblockchainadj-3200x2400.webp"></p>
<blockquote>
<p>文章的主要思想和内容均来自：<a target="_blank" rel="noopener" href="https://jeiwan.cc/posts/building-blockchain-in-go-part-3/">https://jeiwan.cc/posts/building-blockchain-in-go-part-3/</a></p>
</blockquote>
<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>上一篇 文章我们实现了区块链的工作量证明机制（Pow），尽可能地实现了挖矿。但是距离真正的区块链应用还有很多重要的特性没有实现。今天我们来实现区块链数据的存储机制，将每次生成的区块链数据保存下来。有一点需要注意，区块链本质上是一款分布式的数据库，我们这里不实现”分布式”，只聚焦于数据存储部分。</p>
<span id="more"></span>

<h2 id="数据库选择"><a href="#数据库选择" class="headerlink" title="数据库选择"></a>数据库选择</h2><p>到目前为止，我们的实现机制中还没有区块存储这一环节，导致我们的区块每次生成之后都保存在了内存中。这样不便于我们重新使用区块链，每次都要从头开始生成区块，也不能够跟他人共享我们的区块链，因此，我们需要将其存储在磁盘上。</p>
<p>我们该选择哪一款数据库呢？事实上，在<a target="_blank" rel="noopener" href="https://github.com/wangweiX/blockchain-explore/tree/master/white-paper/0000-bitcoin">《比特币白皮书》</a>中并没有明确指定使用哪一种的数据库，因此这个由开发人员自己决定。中本聪 开发的 <a target="_blank" rel="noopener" href="https://github.com/bitcoin/bitcoin">Bitcoin Core</a> 中使用的是<a target="_blank" rel="noopener" href="https://github.com/google/leveldb">LevelDB</a>。原文 <a target="_blank" rel="noopener" href="https://jeiwan.cc/posts/building-blockchain-in-go-part-3/">Building Blockchain in Go. Part 3: Persistence and CLI</a> 中使用的是 BoltDB ，对Go语言支持比较好。</p>
<p>但是我们这里使用的是Java来实现，BoltDB不支持Java，这里我们选用 <a target="_blank" rel="noopener" href="https://github.com/facebook/rocksdb">Rocksdb</a> 。</p>
<blockquote>
<p>当然也可以选择 LevelDB，非常不错的LevelDB介绍文章：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/rN6HX2VzsRi3_EKXYKuJAA">https://mp.weixin.qq.com/s/rN6HX2VzsRi3_EKXYKuJAA</a><br>RocksDB是由Facebook数据库工程团队开发和维护的一款key-value存储引擎，比LevelDB性能更加强大，有关Rocksdb的详细介绍，请移步至官方文档：<a target="_blank" rel="noopener" href="https://github.com/facebook/rocksdb">https://github.com/facebook/rocksdb</a> ，这里不多做介绍。</p>
</blockquote>
<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><p>在我们开始实现数据持久化之前，我们先要确定我们该如何去存储我们的数据。为此，我们先来看看比特币是怎么做的。</p>
<p>简单来讲，比特币使用了两个”buckets(桶)”来存储数据：</p>
<ul>
<li>blocks. 描述链上所有区块的元数据.</li>
<li>chainstate. 存储区块链的状态，指的是当前所有的UTXO（未花费交易输出）以及一些元数据.</li>
</ul>
<blockquote>
<p>“在比特币的世界里既没有账户，也没有余额，只有分散到区块链里的UTXO。”<br>详见：<a target="_blank" rel="noopener" href="https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch06.asciidoc#transaction-outputs-and-inputs">《精通比特币》第二版 第06章节 —— 交易的输入与输出</a></p>
</blockquote>
<p>此外，每个区块数据都是以单独的文件形式存储在磁盘上。这样做是出于性能的考虑：当读取某一个单独的区块数据时，不需要加载所有的区块数据到内存中来。</p>
<p>在 blocks 这个桶中，存储的键值对：</p>
<ul>
<li>‘b’ + 32-byte block hash -&gt; block index record<blockquote>
<p>区块的索引记录</p>
</blockquote>
</li>
<li>‘f’ + 4-byte file number -&gt; file information record<blockquote>
<p>文件信息记录</p>
</blockquote>
</li>
<li>‘l’ -&gt; 4-byte file number: the last block file number used<blockquote>
<p>最新的一个区块所使用的文件编码</p>
</blockquote>
</li>
<li>‘R’ -&gt; 1-byte boolean: whether we’re in the process of reindexing<blockquote>
<p>是否处于重建索引的进程当中</p>
</blockquote>
</li>
<li>‘F’ + 1-byte flag name length + flag name string -&gt; 1 byte boolean: various flags that can be on or off<blockquote>
<p>各种可以打开或关闭的flag标志</p>
</blockquote>
</li>
<li>‘t’ + 32-byte transaction hash -&gt; transaction index record<blockquote>
<p>交易索引记录<br>在 chainstate 这个桶中，存储的键值对：</p>
</blockquote>
</li>
<li>‘c’ + 32-byte transaction hash -&gt; unspent transaction output record for that transaction<blockquote>
<p>某笔交易的UTXO记录</p>
</blockquote>
</li>
<li>‘B’ -&gt; 32-byte block hash: the block hash up to which the database represents the unspent transaction outputs<blockquote>
<p>数据库所表示的UTXO的区块Hash（抱歉，这一点我还没弄明白……）</p>
</blockquote>
</li>
</ul>
<p>由于我们还没有实现交易相关的特性，因此，我们这里只使用 block 桶。另外，前面提到过的，这里我们不会实现各个区块数据各自存储在独立的文件上，而是统一存放在一个文件里面。因此，我们不要存储和文件编码相关的数据，这样一来，我们所用到的键值对就简化为：</p>
<ul>
<li>32-byte block-hash -&gt; Block structure (serialized)<blockquote>
<p>区块数据与区块hash的键值对</p>
</blockquote>
</li>
<li>‘l’ -&gt; the hash of the last block in a chain<blockquote>
<p>最新一个区块hash的键值对<br>(<a target="_blank" rel="noopener" href="https://en.bitcoin.it/wiki/Bitcoin_Core_0.11_(ch_2):_Data_Storage">查看更加详细的解释</a>)</p>
</blockquote>
</li>
</ul>
<h2 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h2><p>RocksDB的Key与Value只能以byte[]的形式进行存储，这里我们需要用到序列化与反序列化库 <a target="_blank" rel="noopener" href="https://github.com/EsotericSoftware/kryo">Kryo</a>，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> one.wangwei.blockchain.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.esotericsoftware.kryo.Kryo;</span><br><span class="line"><span class="keyword">import</span> com.esotericsoftware.kryo.io.Input;</span><br><span class="line"><span class="keyword">import</span> com.esotericsoftware.kryo.io.Output;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 序列化工具类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wangwei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/02/07</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerializeUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 反序列化</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes 对象对应的字节数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">        Input input = <span class="keyword">new</span> Input(bytes);</span><br><span class="line">        Object obj = <span class="keyword">new</span> Kryo().readClassAndObject(input);</span><br><span class="line">        input.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 序列化</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> object 需要序列化的对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] serialize(Object object) &#123;</span><br><span class="line">        Output output = <span class="keyword">new</span> Output(<span class="number">4096</span>, -<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">new</span> Kryo().writeClassAndObject(output, object);</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = output.toBytes();</span><br><span class="line">        output.close();</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h2><p>上面已经说过，我们这里使用RocksDB，我们先写一个相关的工具类RocksDBUtils，主要的功能如下：</p>
<ul>
<li>putLastBlockHash：保存最新一个区块的Hash值</li>
<li>getLastBlockHash：查询最新一个区块的Hash值</li>
<li>putBlock：保存区块</li>
<li>getBlock：查询区块<blockquote>
<p>注意：BoltDB 支持 Bucket 的特性，而RocksDB 不支持，所以需要我们自己使用Map来做一个映射。</p>
</blockquote>
<h3 id="RocksDBUtils"><a href="#RocksDBUtils" class="headerlink" title="RocksDBUtils"></a>RocksDBUtils</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> one.wangwei.blockchain.store;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.Maps;</span><br><span class="line"><span class="keyword">import</span> one.wangwei.blockchain.block.Block;</span><br><span class="line"><span class="keyword">import</span> one.wangwei.blockchain.util.SerializeUtils;</span><br><span class="line"><span class="keyword">import</span> org.rocksdb.RocksDB;</span><br><span class="line"><span class="keyword">import</span> org.rocksdb.RocksDBException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 存储工具类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wangwei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/02/27</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RocksDBUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 区块链数据文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DB_FILE = <span class="string">&quot;blockchain.db&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 区块桶前缀</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String BLOCKS_BUCKET_KEY = <span class="string">&quot;blocks&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最新一个区块</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LAST_BLOCK_KEY = <span class="string">&quot;l&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> RocksDBUtils instance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RocksDBUtils <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (RocksDBUtils.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> RocksDBUtils();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RocksDB db;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * block buckets</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, <span class="keyword">byte</span>[]&gt; blocksBucket;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">RocksDBUtils</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        openDB();</span><br><span class="line">        initBlockBucket();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 打开数据库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">openDB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            db = RocksDB.open(DB_FILE);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RocksDBException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Fail to open db ! &quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化 blocks 数据桶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initBlockBucket</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] blockBucketKey = SerializeUtils.serialize(BLOCKS_BUCKET_KEY);</span><br><span class="line">            <span class="keyword">byte</span>[] blockBucketBytes = db.get(blockBucketKey);</span><br><span class="line">            <span class="keyword">if</span> (blockBucketBytes != <span class="keyword">null</span>) &#123;</span><br><span class="line">                blocksBucket = (Map) SerializeUtils.deserialize(blockBucketBytes);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                blocksBucket = Maps.newHashMap();</span><br><span class="line">                db.put(blockBucketKey, SerializeUtils.serialize(blocksBucket));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RocksDBException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Fail to init block bucket ! &quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存最新一个区块的Hash值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tipBlockHash</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putLastBlockHash</span><span class="params">(String tipBlockHash)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            blocksBucket.put(LAST_BLOCK_KEY, SerializeUtils.serialize(tipBlockHash));</span><br><span class="line">            db.put(SerializeUtils.serialize(BLOCKS_BUCKET_KEY), SerializeUtils.serialize(blocksBucket));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RocksDBException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Fail to put last block hash ! &quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询最新一个区块的Hash值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLastBlockHash</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] lastBlockHashBytes = blocksBucket.get(LAST_BLOCK_KEY);</span><br><span class="line">        <span class="keyword">if</span> (lastBlockHashBytes != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (String) SerializeUtils.deserialize(lastBlockHashBytes);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存区块</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> block</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putBlock</span><span class="params">(Block block)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            blocksBucket.put(block.getHash(), SerializeUtils.serialize(block));</span><br><span class="line">            db.put(SerializeUtils.serialize(BLOCKS_BUCKET_KEY), SerializeUtils.serialize(blocksBucket));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RocksDBException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Fail to put block ! &quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询区块</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> blockHash</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Block <span class="title">getBlock</span><span class="params">(String blockHash)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Block) SerializeUtils.deserialize(blocksBucket.get(blockHash));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭数据库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeDB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            db.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Fail to close db ! &quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="创建区块链"><a href="#创建区块链" class="headerlink" title="创建区块链"></a>创建区块链</h2>现在我们来优化 Blockchain.newBlockchain 接口的代码逻辑，改为如下逻辑：<br><img src="https://img.i7years.com/blog/blockchain_flow.jpg" alt="blockchain_flow"></li>
</ul>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * &lt;p&gt; 创建区块链 &lt;/p&gt;</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Blockchain <span class="title">newBlockchain</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String lastBlockHash = RocksDBUtils.getInstance().getLastBlockHash();</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(lastBlockHash)) &#123;</span><br><span class="line">        Block genesisBlock = Block.newGenesisBlock();</span><br><span class="line">        lastBlockHash = genesisBlock.getHash();</span><br><span class="line">        RocksDBUtils.getInstance().putBlock(genesisBlock);</span><br><span class="line">        RocksDBUtils.getInstance().putLastBlockHash(lastBlockHash);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> Blockchain(lastBlockHash);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改 Blockchain 的数据结构，只记录最新一个区块链的Hash值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Blockchain</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> String lastBlockHash;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Blockchain</span><span class="params">(String lastBlockHash)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lastBlockHash = lastBlockHash;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每次挖矿完成后，我们也需要将最新的区块信息保存下来，并且更新最新区块链Hash值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; 添加区块  &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBlock</span><span class="params">(String data)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">   String lastBlockHash = RocksDBUtils.getInstance().getLastBlockHash();</span><br><span class="line">   <span class="keyword">if</span> (StringUtils.isBlank(lastBlockHash)) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;Fail to add block into blockchain ! &quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">this</span>.addBlock(Block.newBlock(lastBlockHash, data));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; 添加区块  &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> block</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBlock</span><span class="params">(Block block)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    RocksDBUtils.getInstance().putLastBlockHash(block.getHash());</span><br><span class="line">    RocksDBUtils.getInstance().putBlock(block);</span><br><span class="line">    <span class="keyword">this</span>.lastBlockHash = block.getHash();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到此，存储部分的功能就实现完毕，我们还缺少一个功能：</p>
<h2 id="检索区块链"><a href="#检索区块链" class="headerlink" title="检索区块链"></a>检索区块链</h2><p>现在，我们所有的区块都保存到了数据库，因此，我们能够重新打开已有的区块链并且向其添加新的区块。但这也导致我们再也无法打印出区块链中所有区块的信息，因为，我们没有将区块存储在数组当中。让我们来修复这个瑕疵！</p>
<p>我们在Blockchain中创建一个内部类 BlockchainIterator ，作为区块链的迭代器，通过区块之前的hash连接来依次迭代输出区块信息，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Blockchain</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    ....</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 区块链迭代器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlockchainIterator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String currentBlockHash;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BlockchainIterator</span><span class="params">(String currentBlockHash)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.currentBlockHash = currentBlockHash;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 是否有下一个区块</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hashNext</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isBlank(currentBlockHash)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Block lastBlock = RocksDBUtils.getInstance().getBlock(currentBlockHash);</span><br><span class="line">            <span class="keyword">if</span> (lastBlock == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 创世区块直接放行</span></span><br><span class="line">            <span class="keyword">if</span> (lastBlock.getPrevBlockHash().length() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> RocksDBUtils.getInstance().getBlock(lastBlock.getPrevBlockHash()) != <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 返回区块</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Block <span class="title">next</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            Block currentBlock = RocksDBUtils.getInstance().getBlock(currentBlockHash);</span><br><span class="line">            <span class="keyword">if</span> (currentBlock != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.currentBlockHash = currentBlock.getPrevBlockHash();</span><br><span class="line">                <span class="keyword">return</span> currentBlock;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;   </span><br><span class="line">    </span><br><span class="line">    ....    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wangwei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/02/05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlockchainTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Blockchain blockchain = Blockchain.newBlockchain();</span><br><span class="line"></span><br><span class="line">            blockchain.addBlock(<span class="string">&quot;Send 1.0 BTC to wangwei&quot;</span>);</span><br><span class="line">            blockchain.addBlock(<span class="string">&quot;Send 2.5 more BTC to wangwei&quot;</span>);</span><br><span class="line">            blockchain.addBlock(<span class="string">&quot;Send 3.5 more BTC to wangwei&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Blockchain.BlockchainIterator iterator = blockchain.getBlockchainIterator(); iterator.hashNext(); ) &#123;</span><br><span class="line">                Block block = iterator.next();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (block != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">boolean</span> validate = ProofOfWork.newProofOfWork(block).validate();</span><br><span class="line">                    System.out.println(block.toString() + <span class="string">&quot;, validate = &quot;</span> + validate);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*输出*/</span></span><br><span class="line"></span><br><span class="line">Block&#123;hash=<span class="string">&#x27;0000012f87a0510dd0ee7048a6bd52db3002bae7d661126dc28287bd6c23189a&#x27;</span>, prevBlockHash=<span class="string">&#x27;0000024b2c23c4fb06c2e2c1349275d415efe17a51db24cd4883da0067300ddf&#x27;</span>, data=<span class="string">&#x27;Send 3.5 more BTC to wangwei&#x27;</span>, timeStamp=<span class="number">1519724875</span>, nonce=<span class="number">369110</span>&#125;, validate = <span class="keyword">true</span></span><br><span class="line">Block&#123;hash=<span class="string">&#x27;0000024b2c23c4fb06c2e2c1349275d415efe17a51db24cd4883da0067300ddf&#x27;</span>, prevBlockHash=<span class="string">&#x27;00000b14fefb51ba2a7428549d469bcf3efae338315e7289d3e6dc4caf589d79&#x27;</span>, data=<span class="string">&#x27;Send 2.5 more BTC to wangwei&#x27;</span>, timeStamp=<span class="number">1519724872</span>, nonce=<span class="number">896348</span>&#125;, validate = <span class="keyword">true</span></span><br><span class="line">Block&#123;hash=<span class="string">&#x27;00000b14fefb51ba2a7428549d469bcf3efae338315e7289d3e6dc4caf589d79&#x27;</span>, prevBlockHash=<span class="string">&#x27;0000099ced1b02f40c750c5468bb8c4fd800ec9f46fea5d8b033e5d054f0f703&#x27;</span>, data=<span class="string">&#x27;Send 1.0 BTC to wangwei&#x27;</span>, timeStamp=<span class="number">1519724869</span>, nonce=<span class="number">673955</span>&#125;, validate = <span class="keyword">true</span></span><br><span class="line">Block&#123;hash=<span class="string">&#x27;0000099ced1b02f40c750c5468bb8c4fd800ec9f46fea5d8b033e5d054f0f703&#x27;</span>, prevBlockHash=<span class="string">&#x27;&#x27;</span>, data=<span class="string">&#x27;Genesis Block&#x27;</span>, timeStamp=<span class="number">1519724866</span>, nonce=<span class="number">840247</span>&#125;, validate = <span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<h2 id="命令行界面"><a href="#命令行界面" class="headerlink" title="命令行界面"></a>命令行界面</h2><p>CLI 部分的内容，这里不做详细介绍，具体可以去查看文末的Github源码链接。大致步骤如下：</p>
<p>添加pom.xml配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">	<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-cli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-cli<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">	<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">addClasspath</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addClasspath</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">classpathPrefix</span>&gt;</span>lib/<span class="tag">&lt;/<span class="name">classpathPrefix</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>one.wangwei.blockchain.cli.Main<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">				<span class="comment">&lt;!-- this is used for inheritance merges --&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">				<span class="comment">&lt;!-- 指定在打包节点执行jar包合并操作 --&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">   </span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>添加shell脚本 blockchain.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check if the jar has been built.</span></span><br><span class="line"><span class="keyword">if</span> [ ! -e target/blockchain-java-jar-with-dependencies.jar ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;Compiling blockchain project to a JAR&quot;</span></span><br><span class="line">  mvn package -DskipTests</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">java -jar target/blockchain-java-jar-with-dependencies.jar <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br></pre></td></tr></table></figure>
<p>执行命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入工程根路劲</span></span><br><span class="line">$ <span class="built_in">cd</span> blockchain-java</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印帮助信息</span></span><br><span class="line">$ ./blockchain.sh -h </span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加区块</span></span><br><span class="line">$ ./blockchain.sh -add <span class="string">&quot;Send 1.5 BTC to wangwei&quot;</span></span><br><span class="line">$ ./blockchain.sh -add <span class="string">&quot;Send 2.5 BTC to wangwei&quot;</span></span><br><span class="line">$ ./blockchain.sh -add <span class="string">&quot;Send 3.5 BTC to wangwei&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印区块链</span></span><br><span class="line">$ ./blockchain.sh -<span class="built_in">print</span></span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本篇我们实现了区块链的存储功能，接下来我们将实现地址、交易、钱包这一些列的功能。</p>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><ul>
<li>源代码：<a target="_blank" rel="noopener" href="https://github.com/wangweiX/blockchain-java/tree/part3-persistence">https://github.com/wangweiX/blockchain-java/tree/part3-persistence</a></li>
<li><a target="_blank" rel="noopener" href="https://jeiwan.cc/posts/building-blockchain-in-go-part-3/">https://jeiwan.cc/posts/building-blockchain-in-go-part-3/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/bitcoinbook/bitcoinbook">《精通比特币》第二版</a></li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>基于Java语言构建区块链（三）—— 持久化 &amp; 命令行</p><p><a href="https://chenmobuys.github.io/2019/01/23/build-blockchain-in-java-data-persistence/">https://chenmobuys.github.io/2019/01/23/build-blockchain-in-java-data-persistence/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Chenmobuys</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2019-01-23</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-08-16</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/blockchain/">blockchain</a><a class="link-muted mr-2" rel="tag" href="/tags/java/">java</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2019/01/23/build-blockchain-in-java-transaction-utxo/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">基于Java语言构建区块链（四）—— 交易（UTXO）</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2019/01/21/build-blockchain-in-java-proof-of-work/"><span class="level-item">基于Java语言构建区块链（二）—— 工作量证明</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://avatars.githubusercontent.com/u/33781280?v=4" alt="Chenmobuys"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Chenmobuys</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">26</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">5</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">22</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/chenmobuys" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/chenmobuys"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Weibo" href="https://weibo.com/chenmobuys"><i class="fab fa-weibo"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/java/"><span class="level-start"><span class="level-item">java</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/javascript/"><span class="level-start"><span class="level-item">javascript</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/mysql/"><span class="level-start"><span class="level-item">mysql</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/php/"><span class="level-start"><span class="level-item">php</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/regex/"><span class="level-start"><span class="level-item">regex</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Laravel/"><span class="tag">Laravel</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Laravel%E5%AD%A6%E4%B9%A0/"><span class="tag">Laravel学习</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/backup/"><span class="tag">backup</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/blockchain/"><span class="tag">blockchain</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/centos7/"><span class="tag">centos7</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/curl/"><span class="tag">curl</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">git</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/http/"><span class="tag">http</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/java/"><span class="tag">java</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/javascript/"><span class="tag">javascript</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysql/"><span class="tag">mysql</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysqldump/"><span class="tag">mysqldump</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx/"><span class="tag">nginx</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/php/"><span class="tag">php</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/regex/"><span class="tag">regex</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sort/"><span class="tag">sort</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssh/"><span class="tag">ssh</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssl/"><span class="tag">ssl</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tcpdump/"><span class="tag">tcpdump</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vmware/"><span class="tag">vmware</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/webhook/"><span class="tag">webhook</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%93%9D%E5%B1%8F/"><span class="tag">蓝屏</span><span class="tag">1</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-03T03:39:09.000Z">2021-03-03</time></p><p class="title"><a href="/2021/03/03/bian-yi-an-zhuang-nginx/">编译安装nginx及php</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-11-30T02:37:25.000Z">2020-11-30</time></p><p class="title"><a href="/2020/11/30/fatal-error-base-address-marks-unusable-memory-region/">Fatal Error Base address marks unusable memory region.</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-11-30T02:37:25.000Z">2020-11-30</time></p><p class="title"><a href="/2020/11/30/jie-jue-centos7-zai-vwmare-zhong-wu-fa-quan-pin-de-wen-ti/">解决Centos7在Vmware中无法全屏的问题</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2019-08-19T07:25:36.000Z">2019-08-19</time></p><p class="title"><a href="/2019/08/19/zheng-ze-ru-meng/">正则入门</a></p><p class="categories"><a href="/categories/regex/">regex</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2019-08-19T04:59:21.000Z">2019-08-19</time></p><p class="title"><a href="/2019/08/19/git-webhook/">使用git webhook实现代码自动部署</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">八月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">七月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">一月 2019</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/01/"><span class="level-start"><span class="level-item">一月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="http://tomotoes.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">坏掉的番茄</span></span><span class="level-right"><span class="level-item tag">tomotoes.com</span></span></a></li><li><a class="level is-mobile" href="https://lsgwr.gitee.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">梁山广</span></span><span class="level-right"><span class="level-item tag">lsgwr.gitee.io</span></span></a></li><li><a class="level is-mobile" href="https://wangwei.one" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">维新工坊</span></span><span class="level-right"><span class="level-item tag">wangwei.one</span></span></a></li><li><a class="level is-mobile" href="http://www.ruanyifeng.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">阮一峰</span></span><span class="level-right"><span class="level-item tag">www.ruanyifeng.com</span></span></a></li><li><a class="level is-mobile" href="http://www.laruence.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Laruence</span></span><span class="level-right"><span class="level-item tag">www.laruence.com</span></span></a></li><li><a class="level is-mobile" href="http://type.so" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">也就这样</span></span><span class="level-right"><span class="level-item tag">type.so</span></span></a></li><li><a class="level is-mobile" href="http://nullice.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">不知语冰</span></span><span class="level-right"><span class="level-item tag">nullice.com</span></span></a></li><li><a class="level is-mobile" href="https://www.v2ex.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">V2ex</span></span><span class="level-right"><span class="level-item tag">www.v2ex.com</span></span></a></li><li><a class="level is-mobile" href="https://wu-kan.cn" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">星合の空</span></span><span class="level-right"><span class="level-item tag">wu-kan.cn</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Chenmobuys</a><p class="is-size-7"><span>&copy; 2021 Chenmobuys</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://unpkg.com/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://unpkg.com/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://unpkg.com/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://unpkg.com/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://unpkg.com/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://unpkg.com/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>