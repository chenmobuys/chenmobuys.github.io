<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>基于Java语言构建区块链（四）—— 交易（UTXO） - Chenmobuys</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Chenmobuys"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Chenmobuys"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="文章的主要思想和内容均来自 https:&amp;#x2F;&amp;#x2F;jeiwan.cc&amp;#x2F;posts&amp;#x2F;building-blockchain-in-go-part-4&amp;#x2F;  引言上一篇 文章，我们实现了区块数据的持久化，本篇开始交易环节的实现。交易这一环节是整个比特币系统当中最为关键的一环，并且区块链唯一的目的就是通过安全的、可信的方式来存储交易信息，防止它们创建之后被人恶意篡改。今天我们开始实现交易这一环节，但由于这是"><meta property="og:type" content="blog"><meta property="og:title" content="基于Java语言构建区块链（四）—— 交易（UTXO）"><meta property="og:url" content="https://chenmobuys.github.io/2019/01/23/build-blockchain-in-java-transaction-utxo/"><meta property="og:site_name" content="Chenmobuys"><meta property="og:description" content="文章的主要思想和内容均来自 https:&amp;#x2F;&amp;#x2F;jeiwan.cc&amp;#x2F;posts&amp;#x2F;building-blockchain-in-go-part-4&amp;#x2F;  引言上一篇 文章，我们实现了区块数据的持久化，本篇开始交易环节的实现。交易这一环节是整个比特币系统当中最为关键的一环，并且区块链唯一的目的就是通过安全的、可信的方式来存储交易信息，防止它们创建之后被人恶意篡改。今天我们开始实现交易这一环节，但由于这是"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://chenmobuys.github.io/images/ecommerce-2140604.jpg"><meta property="og:image" content="https://img.i7years.com/blog/transactions-diagram.png"><meta property="article:published_time" content="2019-01-23T02:52:13.000Z"><meta property="article:modified_time" content="2021-08-16T07:29:27.252Z"><meta property="article:author" content="Chenmobuys"><meta property="article:tag" content="blockchain"><meta property="article:tag" content="java"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/images/ecommerce-2140604.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://chenmobuys.github.io/2019/01/23/build-blockchain-in-java-transaction-utxo/"},"headline":"基于Java语言构建区块链（四）—— 交易（UTXO）","image":["https://chenmobuys.github.io/images/ecommerce-2140604.jpg","https://img.i7years.com/blog/transactions-diagram.png"],"datePublished":"2019-01-23T02:52:13.000Z","dateModified":"2021-08-16T07:29:27.252Z","author":{"@type":"Person","name":"Chenmobuys"},"publisher":{"@type":"Organization","name":"Chenmobuys","logo":{"@type":"ImageObject","url":{"text":"Chenmobuys"}}},"description":"文章的主要思想和内容均来自 https:&#x2F;&#x2F;jeiwan.cc&#x2F;posts&#x2F;building-blockchain-in-go-part-4&#x2F;  引言上一篇 文章，我们实现了区块数据的持久化，本篇开始交易环节的实现。交易这一环节是整个比特币系统当中最为关键的一环，并且区块链唯一的目的就是通过安全的、可信的方式来存储交易信息，防止它们创建之后被人恶意篡改。今天我们开始实现交易这一环节，但由于这是"}</script><link rel="canonical" href="https://chenmobuys.github.io/2019/01/23/build-blockchain-in-java-transaction-utxo/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://unpkg.com/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://unpkg.com/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://unpkg.com/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://unpkg.com/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://unpkg.com/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Chenmobuys" type="application/atom+xml">
</head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Chenmobuys</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2019-01-23T02:52:13.000Z" title="2019/1/23 上午10:52:13">2019-01-23</time>发表</span><span class="level-item"><time dateTime="2021-08-16T07:29:27.252Z" title="2021/8/16 下午3:29:27">2021-08-16</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/java/">java</a></span><span class="level-item">44 分钟读完 (大约6589个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">基于Java语言构建区块链（四）—— 交易（UTXO）</h1><div class="content"><p><img src="/images/ecommerce-2140604.jpg"></p>
<blockquote>
<p>文章的主要思想和内容均来自 <a target="_blank" rel="noopener" href="https://jeiwan.cc/posts/building-blockchain-in-go-part-4/">https://jeiwan.cc/posts/building-blockchain-in-go-part-4/</a></p>
</blockquote>
<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>上一篇 文章，我们实现了区块数据的持久化，本篇开始交易环节的实现。交易这一环节是整个比特币系统当中最为关键的一环，并且区块链唯一的目的就是通过安全的、可信的方式来存储交易信息，防止它们创建之后被人恶意篡改。今天我们开始实现交易这一环节，但由于这是一个很大的话题，所以我们分为两部分：第一部分我们将实现区块链交易的基本机制，到第二部分，我们再来研究它的细节。</p>
<span id="more"></span>

<h2 id="比特币交易"><a href="#比特币交易" class="headerlink" title="比特币交易"></a>比特币交易</h2><p>如果你开发过Web应用程序，为了实现支付系统，你可能会在数据库中创建一些数据库表：账户 和 交易记录。账户用于存储用户的个人信息以及账户余额等信息，交易记录用于存储资金从一个账户转移到另一个账户的记录。但是在比特币中，支付系统是以一种完全不一样的方式实现的，在这里：</p>
<ul>
<li>没有账户</li>
<li>没有余额</li>
<li>没有地址</li>
<li>没有 Coins（币）</li>
<li>没有发送者和接受者</li>
</ul>
<p>由于区块链是一个公开的数据库，我们不希望存储有关钱包所有者的敏感信息。Coins 不会汇总到钱包中。交易不会将资金从一个地址转移到另一个地址。没有可保存帐户余额的字段或属性。只有交易信息。那比特币的交易信息里面到底存储的是什么呢？</p>
<h2 id="交易组成"><a href="#交易组成" class="headerlink" title="交易组成"></a>交易组成</h2><p>一笔比特币的交易由 交易输入 和 交易输出 组成，数据结构如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 交易</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wangwei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/03/04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Transaction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交易的Hash</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] txId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交易输入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> TXInput[] inputs;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交易输出</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> TXOutput[] outputs;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一笔交易的 交易输入 其实是指向上一笔交易的交易输出 （这个后面详细说明）。我们钱包里面的 Coin（币）实际是存储在这些 交易输出 里面。下图表示了区块链交易系统里面各个交易相互引用的关系：<br><img src="https://img.i7years.com/blog/transactions-diagram.png" alt="transactions-diagram"><br>注意：</p>
<ol>
<li>有些 交易输出 并不是由 交易输入 产生，而是凭空产生的（后面会详细介绍）。</li>
<li>但，交易输入 必须指向某个 交易输出，它不能凭空产生。</li>
<li>在一笔交易里面，交易输入 可能会来自多笔交易所产生的 交易输出。</li>
</ol>
<p>在整篇文章中，我们将使用诸如“钱”，“币”，“花费”，“发送”，“账户”等词语。但比特币中没有这样的概念，在比特币交易中，交易信息是由 锁定脚本 锁定一个数值，并且只能被所有者的 解锁脚本 解锁。（解铃还须系铃人）</p>
<h2 id="交易输出"><a href="#交易输出" class="headerlink" title="交易输出"></a>交易输出</h2><p>让我们先从交易输出开始，他的数据结构如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 交易输出</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wangwei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/03/04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TXOutput</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> value;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 锁定脚本</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String scriptPubKey;</span><br><span class="line">	</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际上，它表示的是能够存储 “coins（币）”的交易输出（注意 value 字段）。并且这里所谓的 value 实际上是由存储在 ScriptPubKey （锁定脚本）中的一个puzzle（难题） 所锁定。在内部，比特币使用称为脚本的脚本语言，用于定义输出锁定和解锁逻辑。这个语言很原始（这是故意的，以避免可能的黑客和滥用），但我们不会详细讨论它。 你可以在这里找到它的详细解释。<a target="_blank" rel="noopener" href="https://en.bitcoin.it/wiki/Script">here</a></p>
<blockquote>
<p>在比特币中，value 字段存储着 satoshis 的任意倍的数值，而不是BTC的数量。satoshis 是比特币的百万分之一（0.00000001 BTC），因此这是比特币中最小的货币单位（如1美分）（satoshis：聪）。<br>锁定脚本是一个放在一个输出值上的“障碍”，同时它明确了今后花费这笔输出的条件。由于锁定脚本往往含有一个公钥（即比特币地址），在历史上它曾被称作一个脚本公钥代码。在大多数比特币应用源代码中，脚本公钥代码便是我们所说的锁定脚本。</p>
</blockquote>
<p>由于我们还没有实现钱包地址的逻辑，所以这里先暂且忽略锁定脚本相关的逻辑。ScriptPubKey 将会存储任意的字符串（用户定义的钱包地址）</p>
<blockquote>
<p>顺便说一句，拥有这样的脚本语言意味着比特币也可以用作智能合约平台。</p>
</blockquote>
<p>关于 交易输出 的一个重要的事情是它们是不可分割的，这意味着你不能将它所存储的数值拆开来使用。当这个交易输出在新的交易中被交易输入所引用时，它将作为一个整体被花费掉。 如果其值大于所需值，那么剩余的部分则会作为零钱返回给付款方。 这与真实世界的情况类似，例如，您支付5美元的钞票用于购买1美元的东西，那么你将会得到4美元的零钱。</p>
<h2 id="交易输入"><a href="#交易输入" class="headerlink" title="交易输入"></a>交易输入</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 交易输入</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wangwei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/03/04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TXInput</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交易Id的hash值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] txId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交易输出索引</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> txOutputIndex;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解锁脚本</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String scriptSig;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>前面提到过，一个交易输入指向的是某一笔交易的交易输出：</li>
<li>txId 存储的是某笔交易的ID值</li>
<li>txOutputIndex 存储的是交易中这个交易输出的索引位置（因为一笔交易可能包含多个交易输出）<ul>
<li>scriptSig 主要是提供用于交易输出中 ScriptPubKey 所需的验证数据。</li>
<li>如果这个数据被验证正确，那么相应的交易输出将被解锁，并且其中的 value 能够生成新的交易输出；</li>
<li>如果不正确，那么相应的交易输出将不能被交易输入所引用；</li>
</ul>
</li>
</ul>
<p>通过锁定脚本与解锁脚本这种机制，保证了某个用户不能花费属于他人的Coins。</p>
<p>同样，由于我们尚未实现钱包地址功能，ScriptSig 将会存储任意的用户所定义的钱包地址。我们将会在下一章节实现公钥和数字签名验证。</p>
<p>说了这么多，我们来总结一下。交易输出是”Coins”实际存储的地方。每一个交易输出都带有一个锁定脚本，它决定了解锁的逻辑。每一笔新的交易必须至少有一个交易输入与交易输出。一笔交易的交易输入指向前一笔交易的交易输出，并且提供用于锁定脚本解锁需要的数据（ScriptSig 字段），然后利用交易输出中的 value 去创建新的交易输出。</p>
<blockquote>
<p>注意，这段话的原文如下，但是里面有表述错误的地方，交易输出带有的是锁定脚本，而不是解锁脚本。</p>
<p>Let’s sum it up. Outputs are where “coins” are stored. Each output comes with an unlocking script, which determines the logic of unlocking the output. Every new transaction must have at least one input and output. An input references an output from a previous transaction and provides data (the ScriptSig field) that is used in the output’s unlocking script to unlock it and use its value to create new outputs.</p>
</blockquote>
<h2 id="鸡与蛋的问题"><a href="#鸡与蛋的问题" class="headerlink" title="鸡与蛋的问题"></a>鸡与蛋的问题</h2><p>在比特币中，鸡蛋先于鸡出现。交易输入源自于交易输出的逻辑是典型的”先有鸡还是先有蛋”的问题：交易输入产生交易输出，交易输出又会被交易输入所引用。在比特币中，交易输出先于交易输入出现。</p>
<p>当矿工开始开采区块时，区块中会被添加一个 coinbase 交易（创币交易）。coinbase 交易是一种特殊的交易，它不需要以前已经存在的交易输出。它会凭空创建出交易输出（i.e: Coins）。也即，鸡蛋的出现并不需要母鸡，这笔交易是作为矿工成功挖出新的区块后的一笔奖励。</p>
<p>正如你所知道的那样，在区块链的最前端，即第一个区块，有一个创世区块。他产生了区块链中有史以来的第一个交易输出，并且由于没有前一笔交易，也就没有相应的输出，因此不需要前一笔交易的交易输出。</p>
<p>让我们来创建 coinbase 交易：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建CoinBase交易</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> to   收账的钱包地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> data 解锁脚本数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Transaction <span class="title">newCoinbaseTX</span><span class="params">(String to, String data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(data)) &#123;</span><br><span class="line">        data = String.format(<span class="string">&quot;Reward to &#x27;%s&#x27;&quot;</span>, to);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建交易输入</span></span><br><span class="line">    TXInput txInput = <span class="keyword">new</span> TXInput(<span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;&#125;, -<span class="number">1</span>, data);</span><br><span class="line">    <span class="comment">// 创建交易输出</span></span><br><span class="line">    TXOutput txOutput = <span class="keyword">new</span> TXOutput(SUBSIDY, to);</span><br><span class="line">    <span class="comment">// 创建交易</span></span><br><span class="line">    Transaction tx = <span class="keyword">new</span> Transaction(<span class="keyword">null</span>, <span class="keyword">new</span> TXInput[]&#123;txInput&#125;, <span class="keyword">new</span> TXOutput[]&#123;txOutput&#125;);</span><br><span class="line">    <span class="comment">// 设置交易ID</span></span><br><span class="line">    tx.setTxId();</span><br><span class="line">    <span class="keyword">return</span> tx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>coinbase交易只有一个交易输入。在我们的代码实现中，txId 是空数组，txOutputIndex 设置为了 -1。另外，coinbase交易不会在 ScriptSig 字段上存储解锁脚本，相反，存了一个任意的数据。</p>
<blockquote>
<p>在比特币中，第一个 coinbase 交易报刊了如下的信息：”The Times 03/Jan/2009 Chancellor on brink of second bailout for banks”. <a target="_blank" rel="noopener" href="https://blockchain.info/tx/4a5e1e4baab89f3a32518a88c31bc87f618f76673e2cc77ab2127b7afdeda33b?show_adv=true">点击查看</a></p>
</blockquote>
<p>SUBSIDY 是挖矿奖励数量。在比特币中，这个奖励数量没有存储在任何地方，而是依据现有区块的总数进行计算而得到：区块总数 除以 210000。开采创世区块得到的奖励为50BTC，每过 210000 个区块，奖励会减半。在我们的实现中，我们暂且将挖矿奖励设置为常数。（至少目前是这样）</p>
<h2 id="在区块链中存储交易信息"><a href="#在区块链中存储交易信息" class="headerlink" title="在区块链中存储交易信息"></a>在区块链中存储交易信息</h2><p>从现在开始，每一个区块必须存储至少一个交易信息，并且尽可能地避免在没有交易数据的情况下进行挖矿。这意味着我们必须移除 Block 对象中的 date 字段，取而代之的是 transactions：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 区块</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wangwei</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/02/02</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Block</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 区块hash值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String hash;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 前一个区块的hash值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String previousHash;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 交易信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Transaction[] transactions;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 区块创建时间(单位:秒)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> timeStamp;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相应地，newGenesisBlock 与 newBlock 也都需要做改变：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; 创建创世区块 &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> coinbase</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Block <span class="title">newGenesisBlock</span><span class="params">(Transaction coinbase)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Block.newBlock(<span class="string">&quot;&quot;</span>, <span class="keyword">new</span> Transaction[]&#123;coinbase&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt; 创建新区块 &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> previousHash</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> transactions</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Block <span class="title">newBlock</span><span class="params">(String previousHash, Transaction[] transactions)</span> </span>&#123;</span><br><span class="line">     Block block = <span class="keyword">new</span> Block(<span class="string">&quot;&quot;</span>, previousHash, transactions, Instant.now().getEpochSecond(), <span class="number">0</span>);</span><br><span class="line">     ProofOfWork pow = ProofOfWork.newProofOfWork(block);</span><br><span class="line">     PowResult powResult = pow.run();</span><br><span class="line">     block.setHash(powResult.getHash());</span><br><span class="line">     block.setNonce(powResult.getNonce());</span><br><span class="line">     <span class="keyword">return</span> block;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，修改 newBlockchain 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * &lt;p&gt; 创建区块链 &lt;/p&gt;</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> address 钱包地址</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Blockchain <span class="title">newBlockchain</span><span class="params">(String address)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String lastBlockHash = RocksDBUtils.getInstance().getLastBlockHash();</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(lastBlockHash)) &#123;</span><br><span class="line">        <span class="comment">// 创建 coinBase 交易</span></span><br><span class="line">        Transaction coinbaseTX = Transaction.newCoinbaseTX(address, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        Block genesisBlock = Block.newGenesisBlock(coinbaseTX);</span><br><span class="line">        lastBlockHash = genesisBlock.getHash();</span><br><span class="line">        RocksDBUtils.getInstance().putBlock(genesisBlock);</span><br><span class="line">        RocksDBUtils.getInstance().putLastBlockHash(lastBlockHash);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> Blockchain(lastBlockHash);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，代码有钱包地址的接口，将会收到开采创世区块的奖励。</p>
<h2 id="工作量证明（Pow）"><a href="#工作量证明（Pow）" class="headerlink" title="工作量证明（Pow）"></a>工作量证明（Pow）</h2><p>Pow算法必须将存储在区块中的交易信息考虑在内，以保存交易信息存储的一致性和可靠性。因此，我们必须修改 ProofOfWork.prepareData 接口代码逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 准备数据</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 注意：在准备区块数据时，一定要从原始数据类型转化为byte[]，不能直接从字符串进行转换</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> nonce</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">prepareData</span><span class="params">(<span class="keyword">long</span> nonce)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">byte</span>[] prevBlockHashBytes = &#123;&#125;;</span><br><span class="line">   <span class="keyword">if</span> (StringUtils.isNoneBlank(<span class="keyword">this</span>.getBlock().getPrevBlockHash())) &#123;</span><br><span class="line">       prevBlockHashBytes = <span class="keyword">new</span> BigInteger(<span class="keyword">this</span>.getBlock().getPrevBlockHash(), <span class="number">16</span>).toByteArray();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> ByteUtils.merge(</span><br><span class="line">           prevBlockHashBytes,</span><br><span class="line">           <span class="keyword">this</span>.getBlock().hashTransaction(),</span><br><span class="line">           ByteUtils.toBytes(<span class="keyword">this</span>.getBlock().getTimeStamp()),</span><br><span class="line">           ByteUtils.toBytes(TARGET_BITS),</span><br><span class="line">           ByteUtils.toBytes(nonce)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 hashTransaction 代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对区块中的交易信息进行Hash计算</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] hashTransaction() &#123;</span><br><span class="line">   <span class="keyword">byte</span>[][] txIdArrays = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="keyword">this</span>.getTransactions().length][];</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.getTransactions().length; i++) &#123;</span><br><span class="line">       txIdArrays[i] = <span class="keyword">this</span>.getTransactions()[i].getTxId();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> DigestUtils.sha256(ByteUtils.merge(txIds));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样，我们使用哈希值来作为数据的唯一标识。我们希望区块中的所有交易数据都能通过一个哈希值来定义它的唯一标识。为了达到这个目的，我们计算了每一个交易的唯一哈希值，然后将他们串联起来，再对这个串联后的组合进行哈希值计算。</p>
<blockquote>
<p>比特币使用更复杂的技术：它将所有包含在块中的交易表示为 <a target="_blank" rel="noopener" href="https://en.bitcoin.it/wiki/Protocol_documentation#Merkle_Trees">Merkle树</a> ，并在Proof-of-Work系统中使用该树的根散列。 这种方法只需要跟节点的散列值就可以快速检查块是否包含某笔交易，而无需下载所有交易。</p>
</blockquote>
<h2 id="UTXO（未花费交易输出）"><a href="#UTXO（未花费交易输出）" class="headerlink" title="UTXO（未花费交易输出）"></a>UTXO（未花费交易输出）</h2><blockquote>
<p>UTXO：unspend transaction output.（未被花费的交易输出）</p>
<p>在比特币的世界里既没有账户，也没有余额，只有分散到区块链里的UTXO.</p>
</blockquote>
<p>UTXO 是理解比特币交易原理的关键所在，我们先来看一段场景：</p>
<p>场景：假设你过去分别向A、B、C这三个比特币用户购买了BTC，从A手中购买了3.5个BTC，从B手中购买了4.5个BTC，从C手中购买了2个BTC，现在你的比特币钱包里面恰好剩余10个BTC。</p>
<p>问题：这个10个BTC是真正的10个BTC吗？其实不是，这句话可能听起来有点怪。（什么！我钱包里面的BTC不是真正的BTC，你不要吓我……）</p>
<p>解释：前面提到过在比特币的交易系统当中，并不存在账户、余额这些概念，所以，你的钱包里面的10个BTC，并不是说钱包余额为10个BTC。而是说，这10个BTC其实是由你的比特币地址（钱包地址|公钥）锁定了的散落在各个区块和各个交易里面的UTXO的总和。</p>
<p>UTXO 是比特币交易的基本单位，每笔交易都会产生UTXO，一个UTXO可以是一“聪”的任意倍。给某人发送比特币实际上是创造新的UTXO，绑定到那个人的钱包地址，并且能被他用于新的支付。</p>
<p>一般的比特币交易由 交易输入 和 交易输出 两部分组成。A向你支付3.5个BTC这笔交易，实际上产生了一个新的UTXO，这个新的UTXO 等于 3.5个BTC（3.5亿聪），并且锁定到了你的比特币钱包地址上。</p>
<p>假如你要给你女（男）朋友转 1.5 BTC，那么你的钱包会从可用的UTXO中选取一个或多个可用的个体来拼凑出一个大于或等于一笔交易所需的比特币量。比如在这个假设场景里面，你的钱包会选取你和C的交易中的UTXO作为 交易输入，input = 2BTC，这里会生成两个新的交易输出，一个输出（UTXO = 1.5 BTC）会被绑定到你女（男）朋友的钱包地址上，另一个输出（UTXO = 0.5 BTC）会作为找零，重新绑定到你的钱包地址上。</p>
<blockquote>
<p>有关比特币交易这部分更详细的内容，请查看：<a target="_blank" rel="noopener" href="https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch06.asciidoc#transactions">《精通比特币（第二版）》第6章 —— 交易</a></p>
</blockquote>
<p>我们需要找到所有未花费的交易输出（UTXO）。Unspent(未花费) 意味着这些交易输出从未被交易输入所指向。这前面的图片中，UTXO如下：</p>
<ol>
<li>tx0, output 1;</li>
<li>tx1, output 0;</li>
<li>tx3, output 0;</li>
<li>tx4, output 0.</li>
</ol>
<p>当然，当我们检查余额时，我不需要区块链中所有的UTXO，我只需要能被我们解锁的UTXO（当前，我们还没有实现密钥对，而是替代为用户自定义的钱包地址）。首先，我们在交易输入与交易输出上定义锁定-解锁的方法：</p>
<p>交易输入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TXInput</span> </span>&#123;</span><br><span class="line">  	</span><br><span class="line">    ...</span><br><span class="line">     </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断解锁数据是否能够解锁交易输出</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unlockingData</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canUnlockOutputWith</span><span class="params">(String unlockingData)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getScriptSig().endsWith(unlockingData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>交易输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TXOutput</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断解锁数据是否能够解锁交易输出</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unlockingData</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canBeUnlockedWith</span><span class="params">(String unlockingData)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getScriptPubKey().endsWith(unlockingData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们暂时用 unlockingData 来与脚本字段进行比较。我们会在后面的文章中来对这部分内容进行优化，我们将会基于私钥来实现用户的钱包地址。</p>
<p>下一步，查询所有与钱包地址绑定的包含UTXO的交易信息，有点复杂（本篇先这样实现，后面我们做一个与钱包地址映射的UTXO池来进行优化）：</p>
<ul>
<li>从与钱包地址对应的交易输入中查询出所有已被花费了的交易输出</li>
<li>再来排除，寻找包含未被花费的交易输出的交易</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Blockchain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查找钱包地址对应的所有未花费的交易</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address 钱包地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Transaction[] findUnspentTransactions(String address) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Map&lt;String, <span class="keyword">int</span>[]&gt; allSpentTXOs = <span class="keyword">this</span>.getAllSpentTXOs(address);</span><br><span class="line">        Transaction[] unspentTxs = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 再次遍历所有区块中的交易输出</span></span><br><span class="line">        <span class="keyword">for</span> (BlockchainIterator blockchainIterator = <span class="keyword">this</span>.getBlockchainIterator(); blockchainIterator.hashNext(); ) &#123;</span><br><span class="line">            Block block = blockchainIterator.next();</span><br><span class="line">            <span class="keyword">for</span> (Transaction transaction : block.getTransactions()) &#123;</span><br><span class="line"></span><br><span class="line">                String txId = Hex.encodeHexString(transaction.getTxId());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span>[] spentOutIndexArray = allSpentTXOs.get(txId);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> outIndex = <span class="number">0</span>; outIndex &lt; transaction.getOutputs().length; outIndex++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (spentOutIndexArray != <span class="keyword">null</span> &amp;&amp; ArrayUtils.contains(spentOutIndexArray, outIndex)) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 保存不存在 allSpentTXOs 中的交易</span></span><br><span class="line">                    <span class="keyword">if</span> (transaction.getOutputs()[outIndex].canBeUnlockedWith(address)) &#123;</span><br><span class="line">                        unspentTxs = ArrayUtils.add(unspentTxs, transaction);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> unspentTxs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从交易输入中查询区块链中所有已被花费了的交易输出</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address 钱包地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 交易ID以及对应的交易输出下标地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, <span class="keyword">int</span>[]&gt; getAllSpentTXOs(String address) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 定义TxId ——&gt; spentOutIndex[]，存储交易ID与已被花费的交易输出数组索引值</span></span><br><span class="line">        Map&lt;String, <span class="keyword">int</span>[]&gt; spentTXOs = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (BlockchainIterator blockchainIterator = <span class="keyword">this</span>.getBlockchainIterator(); blockchainIterator.hashNext(); ) &#123;</span><br><span class="line">            Block block = blockchainIterator.next();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Transaction transaction : block.getTransactions()) &#123;</span><br><span class="line">                <span class="comment">// 如果是 coinbase 交易，直接跳过，因为它不存在引用前一个区块的交易输出</span></span><br><span class="line">                <span class="keyword">if</span> (transaction.isCoinbase()) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (TXInput txInput : transaction.getInputs()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (txInput.canUnlockOutputWith(address)) &#123;</span><br><span class="line">                        String inTxId = Hex.encodeHexString(txInput.getTxId());</span><br><span class="line">                        <span class="keyword">int</span>[] spentOutIndexArray = spentTXOs.get(inTxId);</span><br><span class="line">                        <span class="keyword">if</span> (spentOutIndexArray == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            spentTXOs.put(inTxId, <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;txInput.getTxOutputIndex()&#125;);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            spentOutIndexArray = ArrayUtils.add(spentOutIndexArray, txInput.getTxOutputIndex());</span><br><span class="line">                            spentTXOs.put(inTxId, spentOutIndexArray);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> spentTXOs;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>得到了所有包含UTXO的交易数据，接下来，我们就可以得到所有UTXO集合了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Blockchain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查找钱包地址对应的所有UTXO</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address 钱包地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> TXOutput[] findUTXO(String address) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transaction[] unspentTxs = <span class="keyword">this</span>.findUnspentTransactions(address);</span><br><span class="line">        TXOutput[] utxos = &#123;&#125;;</span><br><span class="line">        <span class="keyword">if</span> (unspentTxs == <span class="keyword">null</span> || unspentTxs.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> utxos;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Transaction tx : unspentTxs) &#123;</span><br><span class="line">            <span class="keyword">for</span> (TXOutput txOutput : tx.getOutputs()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (txOutput.canBeUnlockedWith(address)) &#123;</span><br><span class="line">                    utxos = ArrayUtils.add(utxos, txOutput);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> utxos;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>现在，我们可以实现获取钱包地址余额的接口了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CLI</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询钱包余额</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address 钱包地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getBalance</span><span class="params">(String address)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Blockchain blockchain = Blockchain.createBlockchain(address);</span><br><span class="line">        TXOutput[] txOutputs = blockchain.findUTXO(address);</span><br><span class="line">        <span class="keyword">int</span> balance = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (txOutputs != <span class="keyword">null</span> &amp;&amp; txOutputs.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (TXOutput txOutput : txOutputs) &#123;</span><br><span class="line">                balance += txOutput.getValue();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.printf(<span class="string">&quot;Balance of &#x27;%s&#x27;: %d\n&quot;</span>, address, balance);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查询 wangwei 这个钱包地址的余额：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./blockchain.sh getbalance -address wangwei</span><br></pre></td></tr></table></figure>

<h2 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h2><p>Balance of ‘wangwei’: 10</p>
<h2 id="转账"><a href="#转账" class="headerlink" title="转账"></a>转账</h2><p>现在，我们想要给某人发送一些币。因此，我们需要创建一笔新的交易，然后放入区块中，再进行挖矿。到目前为止，我们只是实现了 coinbase 交易，现在我们需要实现常见的创建交易接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Transaction</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">   ...</span><br><span class="line">   </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从 from 向  to 支付一定的 amount 的金额</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> from       支付钱包地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> to         收款钱包地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount     交易金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> blockchain 区块链</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Transaction <span class="title">newUTXOTransaction</span><span class="params">(String from, String to, <span class="keyword">int</span> amount, Blockchain blockchain)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SpendableOutputResult result = blockchain.findSpendableOutputs(from, amount);</span><br><span class="line">        <span class="keyword">int</span> accumulated = result.getAccumulated();</span><br><span class="line">        Map&lt;String, <span class="keyword">int</span>[]&gt; unspentOuts = result.getUnspentOuts();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (accumulated &lt; amount) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;ERROR: Not enough funds&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Iterator&lt;Map.Entry&lt;String, <span class="keyword">int</span>[]&gt;&gt; iterator = unspentOuts.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">        TXInput[] txInputs = &#123;&#125;;</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            Map.Entry&lt;String, <span class="keyword">int</span>[]&gt; entry = iterator.next();</span><br><span class="line">            String txIdStr = entry.getKey();</span><br><span class="line">            <span class="keyword">int</span>[] outIdxs = entry.getValue();</span><br><span class="line">            <span class="keyword">byte</span>[] txId = Hex.decodeHex(txIdStr);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> outIndex : outIdxs) &#123;</span><br><span class="line">                txInputs = ArrayUtils.add(txInputs, <span class="keyword">new</span> TXInput(txId, outIndex, from));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        TXOutput[] txOutput = &#123;&#125;;</span><br><span class="line">        txOutput = ArrayUtils.add(txOutput, <span class="keyword">new</span> TXOutput(amount, to));</span><br><span class="line">        <span class="keyword">if</span> (accumulated &gt; amount) &#123;</span><br><span class="line">            txOutput = ArrayUtils.add(txOutput, <span class="keyword">new</span> TXOutput((accumulated - amount), from));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Transaction newTx = <span class="keyword">new</span> Transaction(<span class="keyword">null</span>, txInputs, txOutput);</span><br><span class="line">        newTx.setTxId();</span><br><span class="line">        <span class="keyword">return</span> newTx;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在创建新的交易输出之前，我们需要事先找到所有的UTXO，并确保有足够的金额。这就是 findSpendableOutputs 要干的事情。之后，为每个找到的输出创建一个引用它的输入。接下来，我们创建两个交易输出：</p>
<ul>
<li>一个 output 用于锁定到接收者的钱包地址上。这个是真正被转走的coins；</li>
<li>另一个 output 锁定到发送者的钱包地址上。这个就是 找零。只有当用于支付的UTXO总和大于要支付的金额时，才会创建这部分的 交易输出。记住：交易输出是不可分割的</li>
</ul>
<p>findSpendableOutputs 需要调用我们之前创建的 findUnspentTransactions 接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Blockchain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 寻找能够花费的交易</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address 钱包地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount  花费金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SpendableOutputResult <span class="title">findSpendableOutputs</span><span class="params">(String address, <span class="keyword">int</span> amount)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transaction[] unspentTXs = <span class="keyword">this</span>.findUnspentTransactions(address);</span><br><span class="line">        <span class="keyword">int</span> accumulated = <span class="number">0</span>;</span><br><span class="line">        Map&lt;String, <span class="keyword">int</span>[]&gt; unspentOuts = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Transaction tx : unspentTXs) &#123;</span><br><span class="line"></span><br><span class="line">            String txId = Hex.encodeHexString(tx.getTxId());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> outId = <span class="number">0</span>; outId &lt; tx.getOutputs().length; outId++) &#123;</span><br><span class="line"></span><br><span class="line">                TXOutput txOutput = tx.getOutputs()[outId];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (txOutput.canBeUnlockedWith(address) &amp;&amp; accumulated &lt; amount) &#123;</span><br><span class="line">                    accumulated += txOutput.getValue();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">int</span>[] outIds = unspentOuts.get(txId);</span><br><span class="line">                    <span class="keyword">if</span> (outIds == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        outIds = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;outId&#125;;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        outIds = ArrayUtils.add(outIds, outId);</span><br><span class="line">                    &#125;</span><br><span class="line">                    unspentOuts.put(txId, outIds);</span><br><span class="line">                    <span class="keyword">if</span> (accumulated &gt;= amount) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpendableOutputResult(accumulated, unspentOuts);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法会遍历所有的UTXO并统计他们的总额。当计算的总额恰好大于或者等于需要转账的金额时，方法会停止遍历，然后返回用于支付的总额以及按交易ID分组的交易输出索引值数组。我们不想要花更多的钱。</p>
<p>现在，我们可以修改 Block.mineBlock 接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Block</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">   ...</span><br><span class="line">   </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 打包交易，进行挖矿</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transactions</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mineBlock</span><span class="params">(Transaction[] transactions)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String lastBlockHash = RocksDBUtils.getInstance().getLastBlockHash();</span><br><span class="line">        <span class="keyword">if</span> (lastBlockHash == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;ERROR: Fail to get last block hash ! &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Block block = Block.newBlock(lastBlockHash, transactions);</span><br><span class="line">        <span class="keyword">this</span>.addBlock(block);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，我们来实现转账的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CLI</span> </span>&#123;</span><br><span class="line">   </span><br><span class="line">   ...</span><br><span class="line">  </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转账</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> from</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> to</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String from, String to, <span class="keyword">int</span> amount)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Blockchain blockchain = Blockchain.createBlockchain(from);</span><br><span class="line">        Transaction transaction = Transaction.newUTXOTransaction(from, to, amount, blockchain);</span><br><span class="line">        blockchain.mineBlock(<span class="keyword">new</span> Transaction[]&#123;transaction&#125;);</span><br><span class="line">        RocksDBUtils.getInstance().closeDB();</span><br><span class="line">        System.out.println(<span class="string">&quot;Success!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>转账，意味着创建一笔新的交易并且通过挖矿的方式将其存入区块中。但是，比特币不会像我们这样做，它会把新的交易记录先存到内存池中，当一个矿工准备去开采一个区块时，它会把打包内存池中的所有交易信息，并且创建一个候选区块。只有当这个包含所有交易信息的候选区块被成功开采并且被添加到区块链上时，这些交易信息才算被确认。</p>
<p>让我们来测试一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先确认 wangwei 的余额</span></span><br><span class="line">$ ./blockchain.sh getbalance -address wangwei</span><br><span class="line">Balance of <span class="string">&#x27;wangwei&#x27;</span>: 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 转账</span></span><br><span class="line">$ ./blockchain.sh send -from wangwei -to Pedro -amount 6</span><br><span class="line">Elapsed Time: 0.828 seconds </span><br><span class="line">correct <span class="built_in">hash</span> Hex: 00000c5f50cf72db1f375a5d454f98bc49d07335db921cbef5fa9e58ad34d462 </span><br><span class="line"></span><br><span class="line">Success!</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询 wangwei 的余额</span></span><br><span class="line">$ ./blockchain.sh getbalance -address wangwei</span><br><span class="line">Balance of <span class="string">&#x27;wangwei&#x27;</span>: 4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询 Pedro 的余额</span></span><br><span class="line">$ ./blockchain.sh getbalance -address Pedro</span><br><span class="line">Balance of <span class="string">&#x27;Pedro&#x27;</span>: 6</span><br></pre></td></tr></table></figure>

<p>赞！现在让我们来创建更多的交易并且确保从多个交易输出进行转账是正常的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ ./blockchain.sh send -from Pedro -to Helen -amount 2</span><br><span class="line">Elapsed Time: 2.533 seconds </span><br><span class="line">correct <span class="built_in">hash</span> Hex: 00000c81d541ad407a3767ad633d1147602df86fe14e1962ec145ab17b633e88 </span><br><span class="line"></span><br><span class="line">Success!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ ./blockchain.sh send -from wangwei -to Helen -amount 2</span><br><span class="line">Elapsed Time: 1.481 seconds </span><br><span class="line">correct <span class="built_in">hash</span> Hex: 00000c3f8b82c2b970438f5f1f39d56bb8a9d66341efc92a02ffcbff91acd84b </span><br><span class="line"></span><br><span class="line">Success!</span><br></pre></td></tr></table></figure>
<p>现在，Helen 这个钱包地址上有了两笔从 wangwei 和 Pedro 转账中产生的UTXO，让我们将它们再转账给另外一个人：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ ./blockchain.sh send -from Helen -to Rachel -amount 3</span><br><span class="line">Elapsed Time: 17.136 seconds </span><br><span class="line">correct <span class="built_in">hash</span> Hex: 000000b1226a947166c2b01a15d1cd3558ddf86fe99bad28a0501a2af60f6a02 </span><br><span class="line"></span><br><span class="line">Success!</span><br><span class="line"></span><br><span class="line">$ ./blochchain.sh getbalance -address wangwei</span><br><span class="line">Balance of <span class="string">&#x27;wangwei&#x27;</span>: 2</span><br><span class="line">$ ./blochchain.sh getbalance -address Pedro  </span><br><span class="line">Balance of <span class="string">&#x27;Pedro&#x27;</span>: 4</span><br><span class="line">$ ./blochchain.sh getbalance -address Helen</span><br><span class="line">Balance of <span class="string">&#x27;Helen&#x27;</span>: 1</span><br><span class="line">$ ./blochchain.sh getbalance -address Rachel</span><br><span class="line">Balance of <span class="string">&#x27;Rachel&#x27;</span>: 3</span><br></pre></td></tr></table></figure>
<p>非常棒！让我们来测试一下失败的场景：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ./blochchain.sh send -from wangwei -to Ivan -amount 5 </span><br><span class="line">java.lang.Exception: ERROR: Not enough funds</span><br><span class="line">        at one.wangwei.blockchain.transaction.Transaction.newUTXOTransaction(Transaction.java:104)</span><br><span class="line">        at one.wangwei.blockchain.cli.CLI.send(CLI.java:138)</span><br><span class="line">        at one.wangwei.blockchain.cli.CLI.parse(CLI.java:73)</span><br><span class="line">        at one.wangwei.blockchain.cli.Main.main(Main.java:7)</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本篇内容有点难度，但好歹我们现在有了交易信息了。尽管，缺少像比特币这一类加密货币的一些关键特性：</p>
<ol>
<li>钱包地址。我们还没有基于私钥的真实地址。</li>
<li>奖励。挖矿绝对没有利润。</li>
<li>UTXO池。当我们计算钱包地址的余额时，我们需要遍历所有的区块中的所有交易信息，当有许许多多的区块时，这将花费不少的时间。此外，如果我们想验证以后的交易，可能需要很长时间。 UTXO迟旨在解决这些问题并快速处理交易。</li>
<li>内存池。 这是交易在打包成区块之前存储的地方。 在我们当前的实现中，一个块只包含一笔交易，而且效率很低。</li>
</ol>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><ul>
<li>源代码：<a target="_blank" rel="noopener" href="https://github.com/wangweiX/blockchain-java/tree/part4-transaction1">https://github.com/wangweiX/blockchain-java/tree/part4-transaction1</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch06.asciidoc#transactions">《精通比特币（第二版）》第6章 —— 交易</a></li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>基于Java语言构建区块链（四）—— 交易（UTXO）</p><p><a href="https://chenmobuys.github.io/2019/01/23/build-blockchain-in-java-transaction-utxo/">https://chenmobuys.github.io/2019/01/23/build-blockchain-in-java-transaction-utxo/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Chenmobuys</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2019-01-23</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-08-16</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/blockchain/">blockchain</a><a class="link-muted mr-2" rel="tag" href="/tags/java/">java</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2019/01/23/build-blockchain-in-java-wallet-address/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">基于Java语言构建区块链（五）—— 地址（钱包）</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2019/01/23/build-blockchain-in-java-data-persistence/"><span class="level-item">基于Java语言构建区块链（三）—— 持久化 &amp; 命令行</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://avatars.githubusercontent.com/u/33781280?v=4" alt="Chenmobuys"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Chenmobuys</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">26</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">5</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">22</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/chenmobuys" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/chenmobuys"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Weibo" href="https://weibo.com/chenmobuys"><i class="fab fa-weibo"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/java/"><span class="level-start"><span class="level-item">java</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/javascript/"><span class="level-start"><span class="level-item">javascript</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/mysql/"><span class="level-start"><span class="level-item">mysql</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/php/"><span class="level-start"><span class="level-item">php</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/regex/"><span class="level-start"><span class="level-item">regex</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Laravel/"><span class="tag">Laravel</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Laravel%E5%AD%A6%E4%B9%A0/"><span class="tag">Laravel学习</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/backup/"><span class="tag">backup</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/blockchain/"><span class="tag">blockchain</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/centos7/"><span class="tag">centos7</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/curl/"><span class="tag">curl</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">git</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/http/"><span class="tag">http</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/java/"><span class="tag">java</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/javascript/"><span class="tag">javascript</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysql/"><span class="tag">mysql</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysqldump/"><span class="tag">mysqldump</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx/"><span class="tag">nginx</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/php/"><span class="tag">php</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/regex/"><span class="tag">regex</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sort/"><span class="tag">sort</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssh/"><span class="tag">ssh</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssl/"><span class="tag">ssl</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tcpdump/"><span class="tag">tcpdump</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vmware/"><span class="tag">vmware</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/webhook/"><span class="tag">webhook</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%93%9D%E5%B1%8F/"><span class="tag">蓝屏</span><span class="tag">1</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-03T03:39:09.000Z">2021-03-03</time></p><p class="title"><a href="/2021/03/03/bian-yi-an-zhuang-nginx/">编译安装nginx及php</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-11-30T02:37:25.000Z">2020-11-30</time></p><p class="title"><a href="/2020/11/30/fatal-error-base-address-marks-unusable-memory-region/">Fatal Error Base address marks unusable memory region.</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-11-30T02:37:25.000Z">2020-11-30</time></p><p class="title"><a href="/2020/11/30/jie-jue-centos7-zai-vwmare-zhong-wu-fa-quan-pin-de-wen-ti/">解决Centos7在Vmware中无法全屏的问题</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2019-08-19T07:25:36.000Z">2019-08-19</time></p><p class="title"><a href="/2019/08/19/zheng-ze-ru-meng/">正则入门</a></p><p class="categories"><a href="/categories/regex/">regex</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2019-08-19T04:59:21.000Z">2019-08-19</time></p><p class="title"><a href="/2019/08/19/git-webhook/">使用git webhook实现代码自动部署</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/08/"><span class="level-start"><span class="level-item">八月 2019</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/07/"><span class="level-start"><span class="level-item">七月 2019</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/01/"><span class="level-start"><span class="level-item">一月 2019</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/12/"><span class="level-start"><span class="level-item">十二月 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/01/"><span class="level-start"><span class="level-item">一月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="http://tomotoes.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">坏掉的番茄</span></span><span class="level-right"><span class="level-item tag">tomotoes.com</span></span></a></li><li><a class="level is-mobile" href="https://lsgwr.gitee.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">梁山广</span></span><span class="level-right"><span class="level-item tag">lsgwr.gitee.io</span></span></a></li><li><a class="level is-mobile" href="https://wangwei.one" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">维新工坊</span></span><span class="level-right"><span class="level-item tag">wangwei.one</span></span></a></li><li><a class="level is-mobile" href="http://www.ruanyifeng.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">阮一峰</span></span><span class="level-right"><span class="level-item tag">www.ruanyifeng.com</span></span></a></li><li><a class="level is-mobile" href="http://www.laruence.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Laruence</span></span><span class="level-right"><span class="level-item tag">www.laruence.com</span></span></a></li><li><a class="level is-mobile" href="http://type.so" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">也就这样</span></span><span class="level-right"><span class="level-item tag">type.so</span></span></a></li><li><a class="level is-mobile" href="http://nullice.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">不知语冰</span></span><span class="level-right"><span class="level-item tag">nullice.com</span></span></a></li><li><a class="level is-mobile" href="https://www.v2ex.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">V2ex</span></span><span class="level-right"><span class="level-item tag">www.v2ex.com</span></span></a></li><li><a class="level is-mobile" href="https://wu-kan.cn" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">星合の空</span></span><span class="level-right"><span class="level-item tag">wu-kan.cn</span></span></a></li><li><a class="level is-mobile" href="https://www.cxyzjd.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">程序员宅基地</span></span><span class="level-right"><span class="level-item tag">www.cxyzjd.com</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Chenmobuys</a><p class="is-size-7"><span>&copy; 2021 Chenmobuys</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://unpkg.com/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://unpkg.com/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://unpkg.com/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://unpkg.com/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://unpkg.com/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://unpkg.com/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>